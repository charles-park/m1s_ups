#!/bin/bash

#/*---------------------------------------------------------------------------*/
#/* Define CH55xduino ttyACM VID/PID (1209:c550) */
#/*---------------------------------------------------------------------------*/
VID_CH55xduino="1209"
PID_CH55xduino="C550"

#/*---------------------------------------------------------------------------*/
#/* Define tmp file */
#/*---------------------------------------------------------------------------*/
UPS_TTY_NODE=""

#/*---------------------------------------------------------------------------*/
#/* UPS Command List */
#/*---------------------------------------------------------------------------*/
# Send command to ups off to UPS.
UPS_CMD_POWEROFF="@P0#"

#/*---------------------------------------------------------------------------*/
#/* find ttyNode name : VID_CH55xduino(1209):PID_CH55xduino(c550)
#/*---------------------------------------------------------------------------*/
function find_tty_node {
	UPS_TTY_NODE=`find $(grep -l "PRODUCT=$(printf "%x/%x" "0x${VID_CH55xduino}" "0x${PID_CH55xduino}")" \
					/sys/bus/usb/devices/[0-9]*:*/uevent | sed 's,uevent$,,') \
					/dev/null -name dev -o -name dev_id  | sed 's,[^/]*$,uevent,' |
					xargs sed -n -e s,DEVNAME=,/dev/,p -e s,INTERFACE=,,p`

}

#/*---------------------------------------------------------------------------*/
#/* START Script */
#/*---------------------------------------------------------------------------*/
#/* find CH55xduino ttyACM node (1209:c550) */
#/*---------------------------------------------------------------------------*/
find_tty_node

#/*---------------------------------------------------------------------------*/
#/* Script exit handling when node not found. */
#/*---------------------------------------------------------------------------*/
if [ -z "${UPS_TTY_NODE}" ]; then
	echo "------------------------------------------------------------"
	echo "Can't found ttyACM(CH55xduino) device. (1209:c550)"
	echo "------------------------------------------------------------"
else
	echo "------------------------------------------------------------"
	echo "Found ttyACM(CH55xduino) device. Node name = ${UPS_TTY_NODE}"
	echo "------------------------------------------------------------"
	echo -ne ${UPS_CMD_POWEROFF} > ${UPS_TTY_NODE}
fi

#/*---------------------------------------------------------------------------*/
#/*---------------------------------------------------------------------------*/
